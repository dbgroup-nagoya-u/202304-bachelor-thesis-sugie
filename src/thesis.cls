% This is file "thesis.cls",
% LaTeX Class File for a bachelor's/master's/doctoral thesis.
%
% NOTICE:
% This class file is the extendison of "jsreport.cls", and assumes the use of upLaTeX.
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{thesis}
% [2017/11/09 v1.0.0] % generated by Kento Sugiura
% [2018/01/04 v1.1.0] % updated by Kento Sugiura
% [2018/01/18 v1.1.1] % revised by Kento Sugiura
% [2019/01/14 v2.0.0] % updated by Kento Sugiura
% [2019/01/29 v2.1.0] % updated by Kento Sugiura
% [2019/01/30 v2.1.1] % revised by Kento Sugiura
% [2019/01/30 v2.2.0] % updated by Kento Sugiura
% [2021/02/11 v3.0.0] % updated by Kento Sugiura
% [2021/03/24 v3.0.1] % updated by Kento Sugiura
% [2021/11/24 v3.1.0 for Thesis] % updated by Kento Sugiura
[2023/02/04 v3.1.1 for Thesis] % revised by Kento Sugiura

% Original class options
\newif\if@bachelor
\newif\if@master
\newif\if@doctor
\@doctortrue
\newif\if@existFigure
\newif\if@existTable
\newif\if@existAlgorithm
\@existFiguretrue
\@existTabletrue
\@existAlgorithmtrue

\DeclareOption{bachelor}{
  \@bachelortrue\@masterfalse\@doctorfalse
}
\DeclareOption{master}{
  \@bachelorfalse\@mastertrue\@doctorfalse
}
\DeclareOption{doctor}{
  \@bachelorfalse\@masterfalse\@doctortrue
}
\DeclareOption{nofigure}{
  \@existFigurefalse
}
\DeclareOption{notable}{
  \@existTablefalse
}
\DeclareOption{noalgorithm}{
  \@existAlgorithmfalse
}

% Overlaping class options
\DeclareOption{english}{
  \PassOptionsToClass{\CurrentOption}{bxjsreport}
}
\DeclareOption{yu-win}{
  \PassOptionsToClass{jafont=yu-win10}{bxjsreport}
}

% Fallback
\DeclareOption*{
  \ClassWarning{thesis}{Unknown option '\CurrentOption'}
}

% Process given options
\ProcessOptions\relax

\LoadClass[
  a4paper,
  onecolumn,
  12pt,
  twoside,
  titlepage,
  openright,
  ja=standard,
  autodetect-engine,
  dvi=dvipdfmx,
]{bxjsreport}

%------------------------------------------------------------------------------%
% Layout settings
%------------------------------------------------------------------------------%
% set margins
\setpagelayout*{
  headheight=10pt,
  footskip=0.03367\paperheight,
  headsep=\footskip-\topskip,
  includeheadfoot,
  left=28truemm,
  right=28truemm,
  top=30truemm,
  bottom=30truemm,
}

%------------------------------------------------------------------------------%
% Header and footer layouts
%------------------------------------------------------------------------------%
\RequirePackage{fancyhdr}
\pagestyle{fancy}

\renewcommand{\chaptermark}[1]{\markboth{\@chapapp\thechapter\@chappos\hskip1\jsZw #1}{}}
\renewcommand{\sectionmark}[1]{\markright{\bxjs@label@sect{section}\hskip1\jsZw #1}{}}

% Default header and footer layouts
\fancyhf{} % Clear header and footer
\fancyhead[RO]{\rightmark}
\fancyhead[LE]{\leftmark}
\fancyfoot[RO,LE]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

% Redefining "plain" style for no header and footer layout
\fancypagestyle{plain}{
  \fancyhf{} % Clear header and footer
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% Definition of only-page-number style for bachelor's research report
\fancypagestyle{plainhead}{
  \fancyhf{} % Clear header and footer
  \fancyfoot[RO,LE]{\thepage}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

%
\fancypagestyle{plainfoot}{
  \fancyhf{} % Clear header and footer
  \fancyhead[RO]{\rightmark}
  \fancyhead[LE]{\leftmark}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

%------------------------------------------------------------------------------%
% Algorithm settings
%------------------------------------------------------------------------------%
\newcommand{\@algorithmStyle}{\if@existAlgorithm{algochapter}\else{figure}\fi}
\RequirePackage[
  \@algorithmStyle,
  vlined, % use vertical lines instead of begin-end blocks
  linesnumbered, % show line numbers
  norelsize, % suppress warnings related to relsize.sty
]{algorithm2e}
\if@english\else\SetAlgorithmName{アルゴリズム}{}{アルゴリズム目次}\fi

%------------------------------------------------------------------------------%
% Special chapter names
%------------------------------------------------------------------------------%
\renewcommand{\abstractname}{
  \if@english{Abstract}
  \else
    \if@doctor{概要}\fi
    \if@master{要旨}\fi
    \if@bachelor{内容梗概}\fi
  \fi
}
\renewcommand{\appendixname}{\if@english{Appendix}\else{付録}\fi}
\newcommand{\ackName}{\if@english{Acknowledgement}\else{謝辞}\fi}
\newcommand{\publicationName}{\if@english{List of Publications}\else{関連発表論文}\fi}

%------------------------------------------------------------------------------%
% Macros for title and abstract pages
%------------------------------------------------------------------------------%
% initialize variables
\def\@jpTitle{題目未入力}
\def\@jpAbstTitle{}
\def\@jpAuthor{著者未入力}
\def\@jpAffiliationMain{所属未入力}
\def\@jpAffiliationSub{}
\def\@jpAbstract{概要未入力}
\def\@jpKeyword{キーワード未入力}
\def\@enTitle{no title}
\def\@enAbstTitle{}
\def\@enAuthor{no author}
\def\@enAffiliationMain{no affiliation}
\def\@enAffiliationSub{}
\def\@enAbstract{no abstract}
\def\@enKeyword{no keyword}
\def\@schoolYear{2017}
\def\@year{2018}
\def\@month{1}
\def\@studentNumber{000000000}
% input contents
\newcommand{\titleHeading}[1]{\def\@researchReport{#1}}
\newcommand{\jpTitle}[2][]{\def\@jpAbstTitle{#1} \def\@jpTitle{#2}}
\newcommand{\jpAuthor}[1]{\def\@jpAuthor{#1}}
\newcommand{\jpAffiliationMain}[1]{\def\@jpAffiliationMain{#1}}
\newcommand{\jpAffiliationSub}[1]{\def\@jpAffiliationSub{#1}}
\newcommand{\jpAbstract}[1]{\def\@jpAbstract{#1}}
\newcommand{\jpKeyword}[1]{\def\@jpKeyword{#1}}
\newcommand{\enTitle}[2][]{\def\@enAbstTitle{#1} \def\@enTitle{#2}}
\newcommand{\enAuthor}[1]{\def\@enAuthor{#1}}
\newcommand{\enAffiliationMain}[1]{\def\@enAffiliationMain{#1}}
\newcommand{\enAffiliationSub}[1]{\def\@enAffiliationSub{#1}}
\newcommand{\enAbstract}[1]{\def\@enAbstract{#1}}
\newcommand{\enKeyword}[1]{\def\@enKeyword{#1}}
\newcommand{\setSchoolYear}[1]{\def\@schoolYear{#1}}
\newcommand{\setYear}[1]{\def\@year{#1}}
\newcommand{\setMonth}[1]{\def\@month{#1}}
\newcommand{\@convertMonthFromArabicToEng}[1]{
  \ifcase #1 \or January\or February\or March\or April\or May\or June\or July\or
  August\or September\or October\or November\or December\fi
}
\newcommand{\@jpDate}{\@year 年 \@month 月}
\newcommand{\@enDate}{\@convertMonthFromArabicToEng{\@month} \@year}
\newcommand{\studentNumber}{\def\@studentNumber}
% output japanese/english descriptions according to writing language
\renewcommand{\@title}{\if@english\@enTitle\else\@jpTitle\fi}
\newcommand{\@abstTitle}{\if@english\@enAbstTitle\else\@jpAbstTitle\fi}
\renewcommand{\@author}{\if@english\@enAuthor\else\@jpAuthor\fi}
\renewcommand{\@date}{\if@english\@enDate\else\@jpDate\fi}
\newcommand{\@affiliationMain}{\if@english\@enAffiliationMain\else\@jpAffiliationMain\fi}
\newcommand{\@affiliationSub}{\if@english\@enAffiliationSub\else\@jpAffiliationSub\fi}
\newcommand{\@abstract}{\if@english\@enAbstract\else\@jpAbstract\fi}
\newcommand{\@keyword}{\if@english\@enKeyword\else\@jpKeyword\fi}

%------------------------------------------------------------------------------%
% Title page layouts
%------------------------------------------------------------------------------%
\newcommand{\doctorTitle}{
  \begin{titlepage}
  \centering
  \vspace*{40mm}
  {\bfseries
    {\LARGE\@title\par}
    \vspace{100mm}
    {\Large\@author\par}
% "Date" is not needed in doctoral thesis (2018/01/18)
%    \vspace{5mm}
%    {\Large \@date \par}
  }
  \end{titlepage}
}

\newcommand{\masterJpTitle}{
  \begin{titlepage}
  \centering
  \vspace*{25mm}
  {\bfseries
    {\Large{修士論文}\par}
    \vspace{5mm}
    {\LARGE\@jpTitle\par}
    \vspace{80mm}
    {\Large\@studentNumber\quad\@jpAuthor\par}
    \vspace{5mm}
    {\large\@jpAffiliationMain\par}
    {\large\@jpAffiliationSub\par}
    \vspace{5mm}
    {\large\@schoolYear{年度}\par}
  }
  \end{titlepage}
}

\newcommand{\masterEnTitle}{
  \begin{titlepage}
  \centering
  \vspace*{25mm}
  {\bfseries
    {\Large{Master's Thesis}\par}
    \vspace{5mm}
    {\LARGE\@enTitle\par}
    \vspace{80mm}
    {\Large\@studentNumber\quad\@enAuthor\par}
    \vspace{5mm}
    {\large\@enAffiliationMain\par}
    {\large\@enAffiliationSub\par}
    \vspace{5mm}
    {\large\@enDate\par}
  }
  \end{titlepage}
}

\newcommand{\bachelorTitle}{
  \begin{titlepage}
  \centering
  \vspace*{20truemm}
  {\bfseries
    {\Large\@researchReport\par}
    \vspace{10truemm}
    {\LARGE\@title\par}
    \vspace{90truemm}
    {\large\@date\par}
    \vspace{10truemm}
    {\Large\ifx\@studentNumber\empty\else\@studentNumber\quad\fi\@author\par}
  }
  \end{titlepage}
}

%------------------------------------------------------------------------------%
% Abstract page layouts
%------------------------------------------------------------------------------%
\newcommand{\doctorAbst}{
  \chapter*{\abstractname}
  \markboth{\abstractname}{}
  \@abstract\par
}

\newcommand{\masterJpAbst}{
  \thispagestyle{plain}
  {\centering\bfseries
    {\Large % use no line-break title if it exists
      \ifx\@jpAbstTitle\empty\@jpTitle\else\@jpAbstTitle\fi
    \par}
    \vspace{5mm}
    {\large\@studentNumber\quad\@jpAuthor\par}
    \vspace{5mm}
    {\large{要旨}\par}
    \vspace{2mm}
  }
  \@jpAbstract\par
}

\newcommand{\masterEnAbst}{
  \thispagestyle{plain}
  {\centering\bfseries
    {\Large % use no line-break title if it exists
      \ifx\@enAbstTitle\empty\@enTitle\else\@enAbstTitle\fi
    \par}
    \vspace{5mm}
    {\large\@studentNumber\quad\@enAuthor\par}
    \vspace{5mm}
    {\large{Abstract}\par}
    \vspace{2mm}
  }
  \@enAbstract\par
}

\newcommand{\bachelorAbst}{
  \thispagestyle{plainhead}
  {
    {\centering\bfseries
      {\Large % use no line-break title if it exists
        \if@english
          \ifx\@enAbstTitle\empty\@title\else\@abstTitle\fi
        \else
          \ifx\@jpAbstTitle\empty\@title\else\@abstTitle\fi
        \fi
      \par}
      \vspace{5mm}
      {\large\@author\par}
      \vspace{5mm}
      {\large\abstractname\par}
      \vspace{2mm}
    }
    \@abstract\par
    \vspace{\baselineskip}
    \noindent\textbf{\if@english{Keyword}\else{キーワード}\fi:}\@keyword\par
  }
}

%------------------------------------------------------------------------------%
% Macro for printing all the contents
%------------------------------------------------------------------------------%
\newcommand{\allContents}{
  \tableofcontents
  \if@existFigure
    \listoffigures
  \fi
  \if@existTable
    \listoftables
  \fi
  \if@existAlgorithm
    \listofalgorithms
  \fi
}

%------------------------------------------------------------------------------%
% Redefining "\maketitle"
%------------------------------------------------------------------------------%
\renewcommand{\maketitle}{
  % Printing the title, abstract, and contents pages
  % ----- Doctoral thesis -----
  \if@doctor
    % Printing the title page
    \doctorTitle
    \cleardoublepage
    % Changing the page-numbering style to Roman
    \pagenumbering{roman}
    % Printing the abstract pages
    \doctorAbst
    \cleardoublepage
  \fi
  % ----- Master's thesis -----
  \if@master
    % Printing the abstract pages
    \if@english\else
      \masterJpAbst
      \cleardoublepage
    \fi
    \masterEnAbst
    \cleardoublepage
    % Printing the title page
    \if@english\else
      \masterJpTitle
      \cleardoublepage
    \fi
    \masterEnTitle
    \cleardoublepage
    % Changing the page-numbering style to Roman
    \pagenumbering{roman}
  \fi
  % ----- Bachelor's thesis -----
  \if@bachelor
    % Printing the title page
    \bachelorTitle
    \cleardoublepage
    % Changing the page-numbering style to Roman
    \pagenumbering{roman}
    % Printing the abstract pages
    \bachelorAbst
    \cleardoublepage
  \fi
  % Printing all the contents
  \allContents
  \cleardoublepage
  % Making the page-numbering style back to Arabic
  \pagenumbering{arabic}
}

%------------------------------------------------------------------------------%
% Define special chapters
%------------------------------------------------------------------------------%
\newcommand{\publications}{
  \chapter*{\publicationName}
  \addcontentsline{toc}{chapter}{\publicationName}%
  \markboth{\publicationName}{}
}

\newcommand{\acknowledgement}{
  \chapter*{\ackName}
  \addcontentsline{toc}{chapter}{\ackName}%
  \markboth{\ackName}{}
}
